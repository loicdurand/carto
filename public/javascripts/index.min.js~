function bindData(b){var c=b.value,d=b.getAttribute("name"),e=256*parseInt(c,10),f=Math.round(c*a);b.previousElementSibling.innerHTML=d+": <span>"+e+"px / "+f+"m / "+c+" images</span>"}function getURLs(a,b,c,d,e){var f=[],g=a+b,h="&TileRow=";d=d>=1?d:1;for(var i=1;i<=d;i++){for(var j=a;j<g;j++){var k=""+e+"&TileCol="+j+h+c;f.push(k)}c++}return f}function buildCanvas(a,b,c,d){if(a==b-1){var e=document.createElement("canvas"),f=e.getContext("2d");e.width=256*c,e.height=256*d;for(var g=0,h=0,i=document.getElementsByTagName("img"),j=0;j<i.length;j++)g==e.width&&(g=0,h+=256),f.drawImage(i[j],g,h),g+=256;var k=e.toDataURL("image/jpeg");return k}return!1}function save(a,b,c){fetch("/save",{method:"post",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({image:a})}).then(function(a){if(a.status>=200&&a.status<300)return a.text();throw new Error(a.statusText)}).then(function(a){var c=document.getElementsByTagName("a")[0];c.href=a,c.download=b,c.style.cursor="pointer"})}function getLongLat(a,b){var a=""!=a?a:"nimes";a=a.replace(/ /g,"%20");var c="http://maps.googleapis.com/maps/api/geocode/json?address="+a+"&sensor=false";fetch(c).then(function(a){return a.json()}).then(function(a){if(!a.results||1!=a.results.length)return!1;var d=a.results[0].geometry.location.lat,e=a.results[0].geometry.location.lng,f=document.querySelector("input[name=abcisse]"),g=document.querySelector("input[name=ordonnee]");f.value=long2tile(e,b)||"",g.value=lat2tile(d,b)||""})}function long2tile(a,b){return Math.floor((a+180)/360*Math.pow(2,b))}function lat2tile(a,b){return Math.floor((1-Math.log(Math.tan(a*Math.PI/180)+1/Math.cos(a*Math.PI/180))/Math.PI)/2*Math.pow(2,b))}function addZoomOptions(){for(var b,a=document.getElementById("zoom"),c=6;c<17;c++)b=document.createElement("option"),b.value=c,b.innerHTML=c,16==c&&b.setAttribute("selected","selected"),a.appendChild(b)}const a=152.873984,b="https://wxs.ign.fr/an7nvfzojv5wa96dsga5nk8w/geoportail/wmts?layer=GEOGRAPHICALGRIDSYSTEMS.MAPS.SCAN25TOUR&style=normal&tilematrixset=PM&Service=WMTS&Request=GetTile&Version=1.0.0&Format=image/jpeg&TileMatrix=";document.addEventListener("DOMContentLoaded",function(){addZoomOptions();var a=document.getElementById("zoom"),c=document.querySelector("input[name=adr_depart]");c.onclick=c.onchange=c.onkeyup=function(){var b=this.value;getLongLat(b,a.value)};var d=document.querySelector("input[name=largeur]"),e=document.querySelector("input[name=hauteur]"),f=document.querySelector("select[name=position_depart]");f.onchange=function(){0==this.value?(document.querySelector("input[name=abcisse]").disabled=!0,document.querySelector("input[name=ordonnee]").disabled=!0,document.querySelector("input[name=adr_depart]").disabled=!1):(document.querySelector("input[name=abcisse]").disabled=!1,document.querySelector("input[name=ordonnee]").disabled=!1,document.querySelector("input[name=adr_depart]").disabled=!0)};var g=document.querySelector("input[type=submit]");g.onclick=function(){var g=a.value||16;if(c.value||f){var h=document.getElementById("image_name").value||"image",i=parseInt(d.value,10),j=parseInt(e.value,10),k=i*j,l=0==f.value?i/2+1:0,m=0==f.value?j/2+1:0,n=parseFloat(document.querySelector("input[name=abcisse]").value),o=parseFloat(document.querySelector("input[name=ordonnee]").value),p=n?Math.round(n-l):23870,q=o?Math.round(o-m):33556,r=document.createElement("div");r.innerHTML="";var s=getURLs(p,i,q,j,g);if(s.length<650){var t=s.map(a=>fetch(b+a).then(a=>a.blob()));Promise.all(t).then(a=>{for(var b=0;b<a.length;b++){var c=document.createElement("img");c.src=URL.createObjectURL(a[b]),c.style.width=100/i+"%",c.alt="image_"+b,r.appendChild(c),c.onload=function(){var a=parseInt(this.getAttribute("alt").split("_")[1],10),b=buildCanvas(a,k,i,j);b&&save(b,h)}}var d=document.getElementById("apercu");d.innerHTML="",d.appendChild(r)})}}else alert("PrÃ©ciser un lieu / point sur lequel centrer la carte")},d.onchange=d.onclick=d.onkeyup=e.onchange=e.onkeyup=e.onclick=function(){bindData(this)};var h=document.querySelector("input[type=reset]");h.onclick=function(){window.location.reload()}});