function showModal(a){a=a?a:".modal";var b=document.querySelector(a);b.style.display="block";var c=b.getElementsByClassName("close")[0];c.onclick=function(){b.style.display="none"},window.onclick=function(a){a.target==b&&(b.style.display="none")}}function bindData(b){var c=b.value,d=b.getAttribute("name"),e=256*parseInt(c,10),f=Math.round(c*a);b.previousElementSibling.innerHTML=d+": <span>"+e+"px / "+f+"m / "+c+" images</span>"}function getURLs(a,b,c,d,e){for(var f=[],g=a+b,h="&TileRow=",d=d>=1?d:1,i=1,j=a,i=1;i<=d;i++){for(var j=a;j<g;j++){var k=""+e+"&TileCol="+j+h+c;f.push(k)}c++}return f}function getLongLat(a,b){if(""!=a){a=a.replace(/ /g,"%20");var c="http://maps.googleapis.com/maps/api/geocode/json?address="+a+"&sensor=false";fetch(c).then(function(a){return a.json()}).then(function(a){if(!a.results||1!=a.results.length)return!1;var c=a.results[0].geometry.location;document.querySelector("input[name=abcisse]").value=long2tile(c.lng,b)||"",document.querySelector("input[name=ordonnee]").value=lat2tile(c.lat,b)||""})}}function long2tile(a,b){return Math.floor((a+180)/360*Math.pow(2,b))}function lat2tile(a,b){return Math.floor((1-Math.log(Math.tan(a*Math.PI/180)+1/Math.cos(a*Math.PI/180))/Math.PI)/2*Math.pow(2,b))}function addZoomOptions(){for(var a=6;a<17;a++){var b=document.createElement("option");b.value=a,b.innerHTML=a,16==a&&b.setAttribute("selected","selected"),document.getElementById("zoom").appendChild(b)}}function blob2canvas(a,b,c,d,e,f){var e=e?e:"image",g=new Image;g.crossOrigin="Anonymous";var h=a.getContext("2d");g.onload=function(){h.drawImage(g,c,d);var a=document.getElementsByTagName("canvas")[0];c==a.width-256&&d==a.height-256&&setTimeout(function(){a.toBlob(function(a){var b=document.getElementsByTagName("a")[0];f[6]&&(b.onclick=function(a){compteur+=10,e=e.replace(/--[0-9]+/g,"");var b=parseInt(f[6]-compteur,10)>0?parseInt(f[6]-compteur,10):parseInt(10+(f[6]-compteur),10),c=b<=10?b:10;b>=0?buildMap(f[0],f[1],f[2]+10,c,f[4],e,f[6]):(a.preventDefault(),showModal("#finished"))}),b.href=URL.createObjectURL(a);var c=0==compteur?e+"--0"+compteur:e+"--"+compteur;b.download=c.replace(/(\s+)?.$/,""),b.style.cursor="pointer",showModal("#ready_map")},"image/jpeg")},2e3)},g.src=b}function buildMap(a,c,d,e,f,g,h){var i=document.createElement("div");i.innerHTML="",h&&(e=e>=10?10:e);var j=getURLs(a,c,d,e,f);if(j.length){var k=document.createElement("canvas");k.width=256*c,k.height=256*e;var l=0,m=0;j.map(a=>{l==k.width&&(l=0,m+=256),blob2canvas(k,b+a,l,m,g,arguments),l+=256}),k.style.width="100%";var n=document.getElementById("apercu");n.innerHTML="",n.appendChild(k)}}const a=152.873984,b="https://wxs.ign.fr/an7nvfzojv5wa96dsga5nk8w/geoportail/wmts?layer=GEOGRAPHICALGRIDSYSTEMS.MAPS.SCAN25TOUR&style=normal&tilematrixset=PM&Service=WMTS&Request=GetTile&Version=1.0.0&Format=image/jpeg&TileMatrix=",c=100,d=1e4,e=100;var compteur=0;document.addEventListener("DOMContentLoaded",function(){addZoomOptions(),document.getElementById("limit_total_photos").innerHTML=d,document.getElementById("limit_max_width").innerHTML=e,document.getElementById("limit_max_width_in_px").innerHTML=25600;var a=document.querySelector("input[name=adr_depart]"),b=document.querySelector("input[name=largeur]"),f=document.querySelector("input[name=hauteur]");a.onclick=a.onchange=a.onkeyup=function(){var a=document.getElementById("zoom").value||16;getLongLat(this.value,a)},b.onchange=b.onclick=b.onkeyup=f.onchange=f.onkeyup=f.onclick=function(){bindData(this)};var g=document.querySelector("input[type=reset]");g.onclick=function(){window.location.reload()};var h=document.querySelector("select[name=centered]");h.onchange=function(){var a=document.querySelector("input[name=adr_depart]"),b=document.querySelector("input[name=abcisse]"),c=document.querySelector("input[name=ordonnee]");"O"==this.value?(b.disabled=!0,c.disabled=!0,a.disabled=!1):(b.disabled=!1,c.disabled=!1,a.disabled=!0)};var i=document.querySelector("input[type=submit]");i.onclick=function(){var g={},h=parseInt(b.value,10),i=parseInt(f.value,10),j=h*i,k=document.getElementById("zoom").value||16,l=parseFloat(document.querySelector("input[name=abcisse]").value),m=parseFloat(document.querySelector("input[name=ordonnee]").value),n=document.getElementById("image_name").value||"image";g.larg="O"==document.querySelector("select[name=centered]").value?h/2+1:0,g.haut="O"==document.querySelector("select[name=centered]").value?i/2+1:0;var o=Math.round(l-g.larg),p=Math.round(m-g.haut);a.value||l||m?j<=c?buildMap(o,h,p,i,k,n):j<=d&&h<=e?(showModal("#is_big"),buildMap(o,h,p,i,k,n,i)):showModal("#too_big"):showModal("#no_point")}});
